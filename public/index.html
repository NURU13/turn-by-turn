<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      html {
        height: 100%;
      }

      body {
        font: 75%/1.5em "Helvetica", "Arial", sans-serif;
        height: 100%;
        margin: 0;
      }

      #map {
        position: absolute;
        width: 100%;
        height: 100%;
      }

      form {
        position: fixed;
        top: 5px;
        right: 5px;
        padding: 1.5em;
        background: white;
        border: 1px solid gray;
        box-shadow: 0em 0.125em 0.25em gray;
        width: 18em;
      }

      form p {
        margin: 0 0 1em;
      }

      form table {
        margin: 1em 0 0;
      }

      th {
        font-weight: normal;
        text-align: right;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="out"></div>
    <form id="form" onsubmit="try{directions()}catch(e){}; return false">
      <p>Request directions from <a href="http://maps.google.com/" target="_blank">Google Maps</a>: they will be overlaid with a forecast from <a href="http://darkskyapp.com/" target="_blank">Dark Sky</a>, showing where (and how hard) you&rsquo;ll get rained on if you left right now.</p>

      <table>
        <tr>
          <th>I want to</th>
          <td>
            <select name="mode">
              <option>walk</option>
              <option>bike</option>
              <option>drive</option>
            </select>
          </td>
        </tr>

        <tr>
          <th>from</th>
          <td><input name="from" value="216 Second Street, Troy, NY"></td>
        </tr>

        <tr>
          <th>to</th>
          <td><input name="to" value="417 River Street, Troy, NY"></td>
        </tr>

        <tr>
          <th></th>
          <td><input type="submit" value="Go!"></td>
        </tr>
      </table>
    </form>

    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript">
      function interpolate(path, t) {
        var i, l

        t *= google.maps.geometry.spherical.computeLength(path)

        for(i = 1; i < path.length; i++) {
          l = google.maps.geometry.spherical.computeDistanceBetween(path[i - 1], path[i])

          if(t <= l)
            return google.maps.geometry.spherical.interpolate(path[i - 1], path[i], t / l)

          t -= l
        }

        return path[path.length - 1]
      }

      function extract(route, now, tripStep, maxTripLength) {
        var out = [],
            t = 0,
            elapsed = 0,
            i, leg, j, step, path

        out.push({
          position: route.legs[0].start_location,
          time: now + elapsed
        })

        legs: for(i = 0; i !== route.legs.length; i++) {
          leg = route.legs[i]

          for(j = 0; j !== leg.steps.length; j++) {
            step = leg.steps[j]
            t += step.duration.value

            if(t < tripStep)
              continue

            path = google.maps.geometry.encoding.decodePath(step.polyline.points)
            while(t >= tripStep) {
              elapsed += tripStep
              /* Early out if we've gone further than an hour. */
              if(elapsed >= maxTripLength) {
                t = 0
                break legs
              }

              t -= tripStep

              out.push({
                position: interpolate(path, 1 - t / step.duration.value),
                time: now + elapsed
              })
            }
          }
        }

        if(t > 0) {
          elapsed += t
          t = 0
          out.push({
            position: route.legs[route.legs.length - 1].end_location,
            time: now + elapsed
          })
        }

        return out
      }

      function json(url, callback) {
        var req = new XMLHttpRequest()
        req.open("GET", url, true)
        req.onreadystatechange = function() {
          if(req.readyState !== 4)
            return

          if(req.status !== 200)
            return callback(new Error("Received a non-200 response from the server (" + req.status + ")."))

          return callback(null, JSON.parse(req.responseText))
        }
        req.send(null)
      }

      function forecast(positions, callback) {
        var url = ["/darksky/"],
            i

        for(i = 0; i !== positions.length; i++)
          url.push(
            positions[i].position.lat().toFixed(6), ",",
            positions[i].position.lng().toFixed(6), ",",
            positions[i].time, ";"
          )

        url.pop()

        return json(url.join(""), function(err, res) {
          if(err)
            return callback(err)

          var i = res.precipitation.length

          while(i--) {
            positions[i].probability = res.precipitation[i].probability
            positions[i].intensity   = res.precipitation[i].intensity
            positions[i].error       = res.precipitation[i].error
            positions[i].type        = res.precipitation[i].type
          }

          return callback()
        })
      }

      function marker(map, point, c, i, type) {
        if(i < 2 || i > 57)
          return

        var message = []

        switch(c) {
          case 0: message.push(type, "stopping"); break
          case 1: message.push("sporadic light", type); break
          case 2: message.push("light", type); break
          case 3: message.push("moderate", type); break
          case 4: message.push("heavy", type); break
        }

        message.push("in", i, "minutes")

        overlays.push(new google.maps.Marker({
          map: map,
          position: point,
          title: message.join(" ")
        }))
      }

      function polyline(map, path, c) {
        var color

        switch(c) {
          case 0: return
          case 1: color = "#FE0"; break
          case 2: color = "#FA0"; break
          case 3: color = "#F50"; break
          case 4: color = "#F00"; break
        }

        overlays.push(new google.maps.Polyline({
          map: map,
          path: path,
          strokeColor: color,
          strokeOpacity: 0.667,
          strokeWeight: 24,
          zIndex: c
        }))
      }

      function directions() {
        var form = document.getElementById("form"),
            mode

        switch(form.mode.value) {
          case "walk": mode = google.maps.TravelMode.WALKING; break
          case "bike": mode = google.maps.TravelMode.BICYCLING; break
          default:     mode = google.maps.TravelMode.DRIVING; break
        }

        service.route({
          origin: form.from.value,
          destination: form.to.value,
          travelMode: mode
        }, function(result, status) {
          if(status !== google.maps.DirectionsStatus.OK) {
            alert("I couldn't get directions from Google. Try again!")
            return
          }

          while(overlays.length)
            overlays.pop().setMap(null)

          renderer.setDirections(result)

          var positions = extract(result.routes[0], Math.floor(Date.now() / 1000), 60, 3600)

          forecast(positions, function(err) {
            if(err) {
              alert("I couldn't get a forecast from Dark Sky. Try again!")
              return
            }

            var path = [],
                pc = 0,
                i, w, c

            for(i = 0; i !== positions.length; i++) {
              w = positions[i].probability * positions[i].intensity
                   if(w <  2) c = 0
              else if(w < 15) c = 1
              else if(w < 27) c = 2
              else if(w < 45) c = 3
              else            c = 4

              if(c !== pc) {
                path.push(positions[i].position)
                marker(map, positions[i].position, c, i, positions[i].type)
                polyline(map, path, pc)
                path = []
                pc = c
              }

              path.push(positions[i].position)
            }

            if(i === 60)
              overlays.push(new google.maps.Marker({
                map: map,
                position: positions[positions.length - 1].position,
                title: "forecast ends after 60 minutes"
              }))

            polyline(map, path, pc)
          })
        })
      }

      var map = new google.maps.Map(document.getElementById("map"), {
            center: new google.maps.LatLng(42.7235, -73.6931),
            zoom: 12,
            mapTypeControl: false,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            streetViewControl: false
          }),
          renderer = new google.maps.DirectionsRenderer({
            map: map
          }),
          service = new google.maps.DirectionsService(),
          overlays = []

      directions()
    </script>
  </body>
</html>
